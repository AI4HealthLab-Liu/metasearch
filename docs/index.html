<html>
<head>
    <title>OpenNeuroLab: MetaSearch</title>

    <!-- SlickGrid -->
    <link rel="stylesheet" href="lib/slickgrid/css/smoothness/jquery-ui-1.11.3.custom.css" type="text/css"/>

    <link rel="stylesheet" href="lib/slickgrid/slick.grid.css" type="text/css"/>
    <link rel="stylesheet" href="lib/slickgrid/controls/slick.pager.css" type="text/css"/>

    <script src="lib/slickgrid/lib/jquery-3.1.0.js"></script>
    <script src="lib/slickgrid/lib/jquery.event.drag-2.3.0.js"></script>
    <script src="lib/underscore.js"></script>
    <script src="lib/underscore.math.js"></script>

    <script src="lib/slickgrid/slick.core.js"></script>
    <script src="lib/slickgrid/slick.grid.js"></script>
    <script src="lib/slickgrid/controls/slick.pager.js"></script>
    <script src="lib/slickgrid/slick.dataview.js"></script>
    <!-- End SlickGrid -->

    <script src="lib/d3.min.js"></script>

    <link rel="stylesheet" type="text/css" href="lib/parcoords/d3.parcoords.css" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <script src="lib/parcoords/d3.parcoords.js"></script>
</head>
<body>
<div id="onl-header">
    <div id="onl-icon">
        <img src="logo.png" width="50px"/>
    </div>
    <div id="onl-metatitle">
      <div id="title"><span class="large">MetaSearch</span></div>
      <footer>A metadeta filter from OpenNeuroLab</footer>
    </div>
    <div id="onl-buttons">
        <button id="keep-data">Keep</button>
        <button id="exclude-data">Exclude</button>
        <button id="reset-data">Reset</button>
    </div>
</div>



<div id="filter" class="parcoords"></div>
<div id="pager"></div>
<div id="grid"></div>



<script id="brushing">
    var parcoords;
    var dataset;

    // load csv file and create the chart
    d3.csv('data/phenotype_mri.csv', function (data) {

        // slickgrid needs each data element to have an id
        data.forEach(function (d, i) {
            d.id = d.id || i;
        });
        dataset = data;

        parcoords = d3.parcoords()("#filter")
                .data(data)
                .alpha(0.4)
                .mode("queue") // progressive rendering
                .rate(5)
                .hideAxis(["participant_id", "id", 'MRIs'])
                .render()
                .reorderable()
                .brushMode("1D-axes")
                .autoscale();

        change_color("age");

        parcoords.svg
                 .selectAll(".dimension")
                 .on("click", change_color);

        // setting up grid
        var column_keys = d3.keys(data[0]);
        var linkformatter = function(row, cell, value, columnDef, dataContext) {
            if (value == ''){
                   return '';
             }else{
               var docno = value ? value : "";
               return '<a target="_blank" href="http://brainbox.pasteur.fr/mri/?url=' + docno + '">Link</a>';
         }
         };
        var columns = column_keys.map(function (key, i) {
            if (key == 'MRIs'){
                return {
                    id: key,
                    name: key,
                    field: key,
                    sortable: true,
                    formatter: linkformatter
                }
            } else{
                return {
                    id: key,
                    name: key,
                    field: key,
                    sortable: true
                }
            }
        });

        var options = {
            enableCellNavigation: true,
            enableColumnReorder: false,
            multiColumnSort: false,
            forceFitColumns: true
        };

        var dataView = new Slick.Data.DataView();
        var grid = new Slick.Grid("#grid", dataView, columns, options);
        var pager = new Slick.Controls.Pager(dataView, grid, $("#pager"));

        // wire up model events to drive the grid
        dataView.onRowCountChanged.subscribe(function (e, args) {
            grid.updateRowCount();
            grid.render();
        });

        dataView.onRowsChanged.subscribe(function (e, args) {
            grid.invalidateRows(args.rows);
            grid.render();
        });

        // column sorting
        var sortcol = column_keys[0];
        var sortdir = 1;

        function comparer(a, b) {
            var x = a[sortcol], y = b[sortcol];
            return (x == y ? 0 : (x > y ? 1 : -1));
        }

        // click header to sort grid column
        grid.onSort.subscribe(function (e, args) {
            sortdir = args.sortAsc ? 1 : -1;
            sortcol = args.sortCol.field;

            dataView.sort(comparer, args.sortAsc);
        });

        // highlight row in chart
        grid.onMouseEnter.subscribe(function (e, args) {
            // Get row number from grid
            var grid_row = grid.getCellFromEvent(e).row;

            // Get the id of the item referenced in grid_row
            var item_id = grid.getDataItem(grid_row).id;
            var d = parcoords.brushed() || data;

            // Get the element position of the id in the data object
            elementPos = d.map(function (x) {
                return x.id;
            }).indexOf(item_id);

            // Highlight that element in the parallel coordinates graph
            parcoords.highlight([d[elementPos]]);
        });

        grid.onMouseLeave.subscribe(function (e, args) {
            parcoords.unhighlight();
        });

        // fill grid with data
        gridUpdate(data);

        // update grid on brush
        parcoords.on("brush", function (d) {
            gridUpdate(d);
        });

        function gridUpdate(data) {
            dataView.beginUpdate();
            dataView.setItems(data);
            dataView.endUpdate();
        }

    });

       // Remove all but selected from the dataset
      d3.select("#keep-data")
        .on("click", function() {
          new_data = parcoords.brushed();
          if (new_data.length == 0) {
            alert("Please do not select all the data when keeping/excluding");
            return false;
          }
          callUpdate(new_data);
        });

      // Exclude selected from the dataset
      d3.select("#exclude-data")
        .on("click", function() {
          new_data = _.difference(dataset, parcoords.brushed());
          if (new_data.length == 0) {
            alert("Please do not select all the data when keeping/excluding");
            return false;
          }
          callUpdate(new_data);
        });


      d3.select("#reset-data")
         .on("click", function() {
               callUpdate(dataset);
         });


    var color_scale = d3.scale.linear()
                        .domain([-2,-0.5,0.5,2])
                        .range(["#DE5E60", "steelblue", "steelblue", "#98df8a"])
                        .interpolate(d3.interpolateLab);

    function change_color(dimension) {
      parcoords.svg.selectAll(".dimension")
        .style("font-weight", "normal")
        .filter(function(d) { return d == dimension; })
        .style("font-weight", "bold")

      parcoords.color(zcolor(parcoords.data(), dimension)).render()
    }

    function zcolor(col, dimension) {
      var z = zscore(_(col).pluck(dimension).map(parseFloat));
      return function(d) { return color_scale(z(d[dimension]))}
    };

    function zscore(col) {
      var col2 = _.reject(col, _.isNaN);
      var n = col.length,
      mean = _(col2).mean(),
      sigma = _(col2).stdDeviation();

      if (col2.length > 2){
          return function(d) {
            return (d-mean)/sigma;
          };
      } else{
          return function(d) {
            return 0;
          };
      };
    };

    function callUpdate(data) {
             parcoords.data(data).render().updateAxes();

    }
</script>

</body>
</html>